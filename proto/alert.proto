// TripWire AlertService â€” gRPC service definition.
//
// Agents open a single bidirectional stream (StreamAlerts) to push alert
// events to the dashboard server.  Before streaming, an agent must call
// RegisterAgent to obtain its server-assigned host_id.
//
// Code generated from this file is committed to the repository under
// internal/server/grpc/alertpb/ so that builds do not require protoc.
// Regenerate with:
//   buf generate   (if buf.yaml is present)
//   OR
//   protoc --go_out=internal/server/grpc/alertpb --go_opt=paths=source_relative \
//          --go-grpc_out=internal/server/grpc/alertpb --go-grpc_opt=paths=source_relative \
//          proto/alert.proto

syntax = "proto3";

package tripwire;

option go_package = "github.com/tripwire/agent/internal/server/grpc/alertpb";

// AlertService is the gRPC service exposed by the TripWire dashboard server.
// Agents connect via mTLS and stream alert events for real-time ingestion.
service AlertService {
  // RegisterAgent is called once per connection.  The agent supplies its
  // hostname and platform; the server returns a stable host_id (UUID) that
  // must be embedded in every subsequent AgentEvent.
  rpc RegisterAgent(RegisterRequest) returns (RegisterResponse);

  // StreamAlerts is a bidirectional streaming RPC.  The agent sends a
  // continuous stream of AgentEvent messages; the server may send
  // ServerCommand messages back (e.g., rule reload, shutdown).
  rpc StreamAlerts(stream AgentEvent) returns (stream ServerCommand);
}

// AgentEvent carries one alert from a monitored host to the dashboard.
message AgentEvent {
  // alert_id is a UUID generated by the agent; used for idempotent inserts.
  string alert_id = 1;

  // host_id is the UUID returned by RegisterAgent.
  string host_id = 2;

  // timestamp_us is the event occurrence time as Unix microseconds (agent
  // clock).  The server stores this as the `timestamp` column.
  int64 timestamp_us = 3;

  // tripwire_type is one of "FILE", "NETWORK", or "PROCESS".
  string tripwire_type = 4;

  // rule_name is the name of the TripwireRule that triggered this event.
  string rule_name = 5;

  // event_detail_json is a JSON-encoded object with type-specific fields
  // (e.g. {"path":"/etc/passwd","pid":1234} for FILE events).
  bytes event_detail_json = 6;

  // severity is one of "INFO", "WARN", or "CRITICAL".
  string severity = 7;
}

// RegisterRequest is sent by the agent at the start of a connection.
message RegisterRequest {
  // hostname is the FQDN or short hostname of the monitored host.
  string hostname = 1;

  // platform is "linux", "darwin", or "windows".
  string platform = 2;

  // agent_version is the semantic version of the agent binary (e.g. "1.2.3").
  string agent_version = 3;
}

// RegisterResponse is returned by the dashboard after a successful
// RegisterAgent call.
message RegisterResponse {
  // host_id is the server-assigned UUID for this host.  Agents must embed
  // this value in every AgentEvent.host_id field.
  string host_id = 1;

  // server_time_us is the server's current time as Unix microseconds.
  // Agents may use this to detect large clock skew.
  int64 server_time_us = 2;
}

// ServerCommand is sent by the dashboard to the agent over the StreamAlerts
// response stream.  Currently used for lifecycle signalling; future versions
// will carry rule-update payloads.
message ServerCommand {
  // type identifies the command, e.g. "RELOAD_RULES", "SHUTDOWN".
  string type = 1;

  // payload is an optional JSON-encoded body for the command.
  bytes payload = 2;
}
