# TripWire Agent — gRPC Transport Client

This document describes the gRPC transport client in `internal/transport`, which
delivers alert events from the TripWire agent to the central dashboard server
using a bidirectional `StreamAlerts` gRPC stream with mTLS authentication and
at-least-once delivery semantics via the local SQLite queue.

---

## Overview

The `GRPCClient` (in `internal/transport/grpc_client.go`) implements the
`agent.Transport` interface.  Its responsibilities are:

1. **mTLS dial** — load the agent client certificate, private key, and CA
   certificate from disk; establish a TLS connection that authenticates both
   parties.
2. **RegisterAgent** — call the unary `RegisterAgent` RPC once per connection
   to obtain the server-assigned `host_id` that is embedded in every
   `AgentEvent`.
3. **Queue drain on reconnect** — before forwarding live events, send every
   pending event from the local SQLite queue (oldest first) to the server.
   Each event is removed from the queue only after the server sends an ACK
   `ServerCommand`.
4. **Live-event forwarding** — events generated by watchers and passed via
   `Transport.Send` are forwarded on the open stream.  A separate goroutine
   reads ACKs from the server and increments the `AlertsSentTotal` counter.
5. **Exponential backoff reconnection** — on any connection or stream error
   the client waits an exponentially increasing interval (±25 % jitter, ceiling
   configurable, default 60 s) before reconnecting.  Every attempt increments
   `ReconnectTotal`.

---

## At-Least-Once Delivery

```
agent.handleEvent
   │
   ├─ queue.Enqueue(evt)   ← durable; survives crashes
   │
   └─ transport.Send(evt)  ← best-effort live path
          │
          └─ liveCh ──► GRPCClient run loop
                              │
                              ├─ (on connect) drainQueue:
                              │     Dequeue → stream.Send → stream.Recv(ACK) → queue.Ack
                              │
                              └─ (after drain) processLive:
                                    liveCh → stream.Send
                                    (goroutine) stream.Recv(ACK) → alertsSentTotal++
```

**Why both?**

- `Enqueue` persists the event to SQLite before `Send` is called.  If the
  transport is down (no connection), `Send` returns an error that the agent
  logs as a warning and continues.  The event survives in the queue.
- On the next successful connection, `drainQueue` retrieves and re-delivers
  all unacknowledged events.
- `ON CONFLICT DO NOTHING` on the dashboard side makes duplicate delivery
  idempotent (same `alert_id` is re-sent after reconnect but not double-stored).

---

## Queue Drain Ordering

Events are dequeued in insertion order (`ORDER BY id ASC`) using the
`idx_alert_queue_pending` index.  The drain loop fetches up to 50 events per
batch (`drainBatchSize`) and sends each one synchronously (send then wait for
ACK) before fetching the next batch.  This ensures FIFO delivery and
back-pressure-aware batching.

```
Drain loop:
  for {
      pending = Dequeue(ctx, 50)    // oldest 50 rows
      if empty → break
      for each pe in pending:
          stream.Send(AgentEvent{...})
          cmd = stream.Recv()         // wait for ACK or ERROR
          if ACK: queue.Ack(pe.ID); alertsSentTotal++
          if ERROR: leave in queue (will retry on next reconnect)
  }
```

---

## Connection Lifecycle

```
run() goroutine:
  loop:
    ┌─ termination check (stopCh / ctx.Done)
    ├─ wait backoff (except first attempt)
    └─ runOnce(ctx):
         ┌─ grpc.NewClient (mTLS)
         ├─ RegisterAgent → hostID
         ├─ StreamAlerts → bidirectional stream
         ├─ drainQueue (FIFO delivery of all queued events)
         └─ processLive (live events from liveCh)
              └─ error → return to run loop; reconnectTotal++
```

---

## Metrics

| Method | Description |
|--------|-------------|
| `AlertsSentTotal() int64` | Total ACKed events (queue drain + live path combined) |
| `ReconnectTotal() int64` | Total reconnect attempts (connection losses) |
| `QueueDepth() int` | Current pending-event count (delegates to `DrainQueue.Depth`) |
| `HostID() string` | Server-assigned host UUID after first successful registration |

All four methods read from atomic fields and never block.

---

## Configuration

```go
type ClientConfig struct {
    Addr         string        // gRPC address. Required.
    CertPath     string        // PEM client certificate path.
    KeyPath      string        // PEM client private key path.
    CAPath       string        // PEM CA certificate path.
    ServerName   string        // TLS SNI override (optional).
    Hostname     string        // Sent in RegisterAgent (default: os.Hostname).
    Platform     string        // OS label e.g. "linux".
    AgentVersion string        // Semantic version string.
    MaxBackoff   time.Duration // Reconnect ceiling (default 60 s).
    Insecure     bool          // Disable TLS. For unit tests only.
}
```

In production all three TLS fields (`CertPath`, `KeyPath`, `CAPath`) are
required and match the paths configured under `tls:` in the agent YAML.

---

## Unit Tests

`internal/transport/grpc_client_test.go` runs an in-process gRPC server
(no TLS) to verify:

| Test | Scenario |
|------|----------|
| `TestGRPCClient_QueueDrainOnConnect` | All queued events delivered in FIFO order; queue reaches depth 0 |
| `TestGRPCClient_AlertsSentTotalCountsACKedEvents` | Counter increments for both queued and live events |
| `TestGRPCClient_QueueDepthReflectsUndeliveredRows` | `QueueDepth()` matches SQLite pending-row count |
| `TestGRPCClient_StreamErrorTriggersReconnect` | Server-close causes reconnect; all events eventually delivered |
| `TestGRPCClient_NoQueue_LiveEventsDelivered` | Client works without a queue (live-only path) |
| `TestGRPCClient_StopIsIdempotent` | Multiple Stop calls do not panic |
| `TestGRPCClient_HostIDSetAfterRegister` | HostID set after successful RegisterAgent |
| `TestGRPCClient_SendReturnsErrorAfterStop` | Send returns error once stopped |
| `TestGRPCClient_QueueDrainOrdering_MultiBatch` | Multi-batch drain (n > 50) preserves FIFO order |
| `TestGRPCClient_MetricsAfterQueueDrain` | AlertsSentTotal == queue depth; ReconnectTotal == 0 on clean run |
| `TestGRPCClient_InterfaceCompliance` | Compile-time `agent.Transport` satisfaction check |

Run with:

```bash
go test ./internal/transport/...
```

---

## Dependencies

| Package | Role |
|---------|------|
| `google.golang.org/grpc` | gRPC transport, client streaming |
| `google.golang.org/grpc/credentials` | mTLS transport credentials |
| `google.golang.org/grpc/credentials/insecure` | No-TLS credentials for tests |
| `github.com/google/uuid` | Alert-ID generation for each sent event |
| `modernc.org/sqlite` | Underlying driver (via `internal/queue`) |
