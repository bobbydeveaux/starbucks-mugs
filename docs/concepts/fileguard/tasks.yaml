GeneratedAt: "2026-02-25T20:54:40Z"
Plan: fileguard-plan
Sprints:
- Features:
  - FeatureID: fileguard-feat-project-setup
    FeatureTitle: Project Scaffolding & Database Schema
    Tasks:
    - AcceptanceCriteria:
      - FastAPI app starts without errors and returns 200 on GET /healthz
      - config.py loads all required env vars (DATABASE_URL, REDIS_URL, SECRET_KEY)
        with validation errors on missing values
      - db/session.py provides an async session factory that connects to PostgreSQL
        and closes cleanly
      - Redis client is reachable and ping returns True in a smoke test
      AgentType: backend-engineer
      Dependencies: []
      Description: Bootstrap the FastAPI application entry point, environment-driven
        configuration (Pydantic Settings), and SQLAlchemy async session factory. Includes
        project layout, dependency injection wiring, and Redis client initialisation
        so all downstream modules have stable import targets.
      EstimatedEffort: M
      Files:
      - fileguard/__init__.py
      - fileguard/main.py
      - fileguard/config.py
      - fileguard/db/session.py
      - fileguard/db/__init__.py
      - pyproject.toml
      - requirements.txt
      ID: task-fileguard-feat-project-setup-1
      Title: FastAPI application skeleton, configuration, and database session
    - AcceptanceCriteria:
      - alembic upgrade head runs without errors on a blank database and creates all
        four tables
      - alembic downgrade base cleanly reverts the migration
      - All NOT NULL constraints, foreign keys, and unique indexes defined in the
        LLD are present (verifiable via psql \d)
      - scan_event append-only guard (no UPDATE/DELETE) is enforced at the model or
        trigger level
      AgentType: backend-engineer
      Dependencies:
      - task-fileguard-feat-project-setup-1
      Description: Define SQLAlchemy ORM models for tenant_config, scan_event, batch_job,
        and compliance_report with all columns, constraints, and indexes from the
        LLD schema. Generate and verify the initial Alembic migration so the schema
        applies cleanly against a fresh PostgreSQL instance.
      EstimatedEffort: M
      Files:
      - fileguard/models/__init__.py
      - fileguard/models/tenant_config.py
      - fileguard/models/scan_event.py
      - fileguard/models/batch_job.py
      - fileguard/models/compliance_report.py
      - migrations/env.py
      - migrations/versions/0001_initial_schema.py
      - alembic.ini
      ID: task-fileguard-feat-project-setup-2
      Title: ORM models and Alembic migrations for all four tables
    - AcceptanceCriteria:
      - docker compose up --build starts all services without errors
      - API is reachable at http://localhost:8000/healthz from the host
      - docker compose run app alembic upgrade head applies migrations inside the
        container
      - Final image is under 400 MB and runs as a non-root user
      AgentType: devops-engineer
      Dependencies:
      - task-fileguard-feat-project-setup-1
      Description: Write a multi-stage Dockerfile (builder + slim runtime) for the
        FastAPI service and a docker-compose.yml that wires together the app, PostgreSQL,
        Redis, and a ClamAV container. Compose should run migrations automatically
        on startup and expose the API on a predictable port.
      EstimatedEffort: S
      Files:
      - docker/Dockerfile
      - docker-compose.yml
      - docker/entrypoint.sh
      - .dockerignore
      ID: task-fileguard-feat-project-setup-3
      Title: Dockerfile and Docker Compose for local development
    - AcceptanceCriteria:
      - helm lint helm/ reports no errors or warnings
      - helm template helm/ --set image.tag=test renders all Kubernetes manifests
        without undefined references
      - Deployment template references the correct container port and includes liveness
        and readiness probes
      - Sensitive values (DATABASE_URL, REDIS_URL, SECRET_KEY) are sourced from a
        Secret, not a ConfigMap
      AgentType: devops-engineer
      Dependencies:
      - task-fileguard-feat-project-setup-3
      Description: Create a production-grade Helm chart with templates for the FastAPI
        Deployment, Service, HorizontalPodAutoscaler, ConfigMap, and Secret. Include
        a chart values file with sensible defaults (replica count, resource limits,
        liveness/readiness probes) and a README documenting required value overrides.
      EstimatedEffort: M
      Files:
      - helm/Chart.yaml
      - helm/values.yaml
      - helm/templates/deployment.yaml
      - helm/templates/service.yaml
      - helm/templates/hpa.yaml
      - helm/templates/configmap.yaml
      - helm/templates/secret.yaml
      - helm/templates/_helpers.tpl
      ID: task-fileguard-feat-project-setup-4
      Title: Helm chart for Kubernetes deployment
  - FeatureID: fileguard-feat-auth-gateway
    FeatureTitle: Authentication & Rate Limiting Middleware
    Tasks:
    - AcceptanceCriteria:
      - TenantConfig schema validates and serialises all required fields (api_key_hash,
        jwks_url, client_id, rate_limit_rpm)
      - Middleware returns HTTP 401 for missing/invalid tokens and HTTP 403 for unrecognised
        tenants
      - API key path uses bcrypt.checkpw and OAuth 2.0 path verifies JWT signature
        against fetched JWKS
      - Tenant config is attached to request.state.tenant after successful auth
      AgentType: backend-engineer
      Dependencies: []
      Description: Define the Pydantic TenantConfig schema in fileguard/schemas/tenant.py
        covering API key (bcrypt hash), OAuth 2.0 client credentials (JWKS URL, audience),
        and per-tenant rate limit defaults. Implement the FastAPI auth middleware
        in fileguard/api/middleware/auth.py that validates Bearer tokens via bcrypt
        comparison for API keys and JWT signature verification (JWKS fetch/cache)
        for OAuth 2.0, loading tenant config from the database at request time and
        attaching it to request state.
      EstimatedEffort: M
      Files:
      - fileguard/schemas/tenant.py
      - fileguard/api/middleware/auth.py
      ID: task-fileguard-feat-auth-gateway-1
      Title: Implement tenant schema and authentication middleware
    - AcceptanceCriteria:
      - Middleware returns HTTP 429 with a Retry-After header when the tenant exceeds
        their configured rate limit
      - Sliding window is implemented atomically in Redis (Lua script or pipeline)
        with per-tenant key namespacing
      - Rate limit defaults to 100 req/min when tenant config does not override it
      - Middleware is a no-op (passes through) when Redis is unavailable and logs
        a warning, preserving fail-open behaviour only for rate limiting
      AgentType: backend-engineer
      Dependencies:
      - task-fileguard-feat-auth-gateway-1
      Description: Implement fileguard/api/middleware/rate_limit.py as a FastAPI middleware
        that reads the authenticated tenant from request.state.tenant (set by the
        auth middleware) and enforces a per-tenant sliding window rate limit using
        Redis. Use a sorted-set or Lua-script approach to count requests within the
        last 60 seconds, defaulting to 100 req/min but honouring the tenant-specific
        override from TenantConfig.
      EstimatedEffort: M
      Files:
      - fileguard/api/middleware/rate_limit.py
      ID: task-fileguard-feat-auth-gateway-2
      Title: Implement Redis-backed sliding window rate limiting middleware
  Sprint: 1
- Features:
  - FeatureID: fileguard-feat-document-extractor
    FeatureTitle: Document Text Extractor
    Tasks:
    - AcceptanceCriteria:
      - All six format handlers (PDF, DOCX, CSV, JSON, TXT, ZIP) extract text and
        return a list of (text, byte_offset) tuples or equivalent structure
      - 'Byte-offset mapping is accurate: given an offset from the result, slicing
        the original file bytes at that position returns the matching content'
      - Unsupported or corrupt files raise a documented exception rather than returning
        empty results silently
      - Unit tests covering each format handler pass, including nested ZIP extraction
      AgentType: backend-engineer
      Dependencies: []
      Description: Implement the DocumentExtractor class in fileguard/core/document_extractor.py
        supporting PDF (pdfminer.six), DOCX (python-docx), CSV, JSON, TXT, and ZIP
        archives. Each handler must return normalised text with a byte-offset map
        so downstream PII detection can localise spans back to the original file.
        ZIP extraction should recursively delegate to the appropriate format handler
        for each contained file.
      EstimatedEffort: M
      Files:
      - fileguard/core/document_extractor.py
      - tests/unit/test_document_extractor.py
      ID: task-fileguard-feat-document-extractor-1
      Title: Implement DocumentExtractor with multi-format handlers and byte-offset
        mapping
    - AcceptanceCriteria:
      - Extraction calls execute inside a thread pool and do not block the asyncio
        event loop (verified with a concurrent-request integration test)
      - max_workers is configurable via application settings with a sensible default
      - Executor instance is reused across requests (not instantiated per call)
      AgentType: backend-engineer
      Dependencies:
      - task-fileguard-feat-document-extractor-1
      Description: Wrap the DocumentExtractor's extract method with a ThreadPoolExecutor
        so that CPU-bound parsing (especially PDF and DOCX) does not block the FastAPI
        event loop. Expose a configurable max_workers setting and ensure the executor
        is shared/reused across requests rather than created per call.
      EstimatedEffort: S
      Files:
      - fileguard/core/document_extractor.py
      ID: task-fileguard-feat-document-extractor-2
      Title: Add thread-pool execution for CPU-bound extraction
  - FeatureID: fileguard-feat-av-engine
    FeatureTitle: Antivirus Engine Adapter
    Tasks:
    - AcceptanceCriteria:
      - AVEngineAdapter ABC defines scan(), health_check(), and engine_name/version
        properties
      - Interface is importable and raises TypeError when instantiated directly
      - Type annotations match LLD Section 6 function signatures
      AgentType: backend-engineer
      Dependencies: []
      Description: Implement the abstract base class AVEngineAdapter in av_adapter.py
        defining the plugin contract for all AV engine integrations. Include abstract
        methods for scan, health_check, and engine metadata. Document the fail-secure
        contract that all implementations must honour.
      EstimatedEffort: S
      Files:
      - fileguard/core/av_adapter.py
      ID: task-fileguard-feat-av-engine-1
      Title: Define abstract AVEngineAdapter plugin interface
    - AcceptanceCriteria:
      - ClamAVAdapter.scan() streams file content to clamd socket and parses FOUND/OK/ERROR
        responses correctly
      - Daemon unreachable raises AVEngineUnavailableError causing the pipeline to
        fail-secure (deny, not pass)
      - health_check() returns False (not raises) when clamd socket is absent, True
        when responsive
      - Unit tests mock the socket and cover clean, infected, and unreachable paths
      AgentType: backend-engineer
      Dependencies:
      - task-fileguard-feat-av-engine-1
      Description: Implement ClamAVAdapter extending AVEngineAdapter, connecting to
        clamd via Unix socket using the INSTREAM protocol. Handle daemon-unreachable
        scenarios fail-securely by raising a well-typed exception that the pipeline
        treats as a scan denial. Include health_check() that validates socket availability
        before scanning.
      EstimatedEffort: M
      Files:
      - fileguard/core/adapters/clamav_adapter.py
      ID: task-fileguard-feat-av-engine-2
      Title: Implement ClamAV daemon adapter with fail-secure socket integration
  - FeatureID: fileguard-feat-audit-service
    FeatureTitle: Tamper-Evident Audit Logging
    Tasks:
    - AcceptanceCriteria:
      - AuditService.append_event() writes a new ScanEvent row with a valid HMAC-SHA256
        signature field
      - Signature verification against the stored fields passes for every written
        record
      - No UPDATE or DELETE paths exist on the scan_event table in application code
      - Unit tests cover signing correctness and reject tampered records
      AgentType: backend-engineer
      Dependencies: []
      Description: Build the AuditService class in fileguard/services/audit.py. Compute
        HMAC-SHA256 signatures over (id, file_hash, status, action_taken, created_at)
        and persist signed ScanEvent records to PostgreSQL. Enforce append-only semantics
        at the application layer by never issuing UPDATE or DELETE on scan_event rows.
      EstimatedEffort: M
      Files:
      - fileguard/services/audit.py
      - fileguard/models/scan_event.py
      ID: task-fileguard-feat-audit-service-1
      Title: Implement AuditService with HMAC-SHA256 signing and append-only writes
    - AcceptanceCriteria:
      - Every log line emitted during a scan request contains correlation_id, tenant_id,
        and scan_id fields
      - Logged identifiers match the corresponding scan_event row in PostgreSQL
      - Missing or malformed context values produce a structured error log rather
        than a silent omission
      AgentType: backend-engineer
      Dependencies:
      - task-fileguard-feat-audit-service-1
      Description: Emit structured JSON log entries on every request that include
        correlation_id, tenant_id, and scan_id. Wire these fields into the AuditService
        so every appended ScanEvent record carries the same identifiers for end-to-end
        traceability.
      EstimatedEffort: S
      Files:
      - fileguard/services/audit.py
      - fileguard/api/middleware.py
      ID: task-fileguard-feat-audit-service-2
      Title: Add structured JSON request logging with correlation and tenant context
  Sprint: 2
